#!/bin/bash

echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤ Kubernetes Job"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
if [ $# -eq 0 ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <–∏–º—è_–¥–∂–æ–±—ã>"
    echo "–ü—Ä–∏–º–µ—Ä: $0 profi-scraper-job-test-123"
    exit 1
fi

JOB_NAME=$1

echo "üîç –ò—â–µ–º –ø–æ–¥—ã –¥–ª—è Job: $JOB_NAME"
echo "=================================="

# –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥—ã Job
PODS=$(kubectl get pods -l job-name=$JOB_NAME -o jsonpath='{.items[*].metadata.name}')

if [ -z "$PODS" ]; then
    echo "‚ùå –ü–æ–¥—ã –¥–ª—è Job '$JOB_NAME' –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    echo ""
    echo "üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "   - Job –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω"
    echo "   - Job –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –∏ –ø–æ–¥—ã —É–¥–∞–ª–µ–Ω—ã"
    echo "   - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è Job"
    echo ""
    echo "üîç –î–æ—Å—Ç—É–ø–Ω—ã–µ Jobs:"
    kubectl get jobs
    exit 1
fi

echo "‚úÖ –ù–∞–π–¥–µ–Ω—ã –ø–æ–¥—ã: $PODS"
echo ""

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–∞
for POD in $PODS; do
    echo "üìä –†–µ—Å—É—Ä—Å—ã –ø–æ–¥–∞: $POD"
    echo "----------------------------------"
    
    # –°—Ç–∞—Ç—É—Å –ø–æ–¥–∞
    echo "üìã –°—Ç–∞—Ç—É—Å:"
    kubectl get pod $POD -o wide
    
    echo ""
    
    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
    echo "üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:"
    kubectl top pod $POD 2>/dev/null || echo "   –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ (–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–¥ –µ—â–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è)"
    
    echo ""
    
    # –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    echo "üîç –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
    kubectl describe pod $POD | grep -E "(Status:|Events:|Containers:|Resources:)" | head -20
    
    echo ""
    echo "=================================="
    echo ""
done

echo "üöÄ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:"
echo "   kubectl logs $PODS                    # –õ–æ–≥–∏ –ø–æ–¥–∞"
echo "   kubectl exec -it $PODS -- /bin/bash   # –í–æ–π—Ç–∏ –≤ –ø–æ–¥"
echo "   watch -n 5 'kubectl top pod $PODS'    # –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥"
echo "   kubectl get events --sort-by='.lastTimestamp'  # –°–æ–±—ã—Ç–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞"
